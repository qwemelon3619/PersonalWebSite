{{ template "header.html" . }}
<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<!-- TOAST UI Editor -->
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.css" />
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css" />
<link rel="stylesheet"
    href="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight.min.css" />
<script
    src="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight-all.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" />
<section class="container my-5">
    <form action="/blog-post" method="POST" enctype="multipart/form-data" id="blogform">
        <div class="article-wrapper">
            {{ if .articleNumber }}
            <input type="hidden" name="articleNumber" value="{{ .articleNumber }}">
            {{ end }}
            <div class="mb-3">
                <label for="article-title" class="form-label">Title</label>
                <input class="form-control form-control-lg" name="article-title" placeholder="Title"
                    value="{{ if .post }}{{ .post.Title }}{{ end }}">
            </div>
            <div class="mb-3">
                <label for="thumbnail" class="form-label">Thumbnail</label>
                <input type="file" class="form-control" name="thumbnail" accept="image/*">
                {{ if .post.Thumbnail }}<img src="{{ .post.Thumbnail }}" alt="Current thumbnail"
                    style="max-width: 200px; margin-top: 10px;">{{ end }}
            </div>
            <div class="mb-3">
                <label for="article-tags" class="form-label">Tags</label>
                <input class="form-control" name="tags" placeholder="comma separated - e.g. go, web, gin"
                    value="{{ if .post }}{{ range $i, $t := .post.Tags }}{{if $i}}, {{end}}{{ $t.Name }}{{ end }}{{ end }}">
                <div class="form-text">Separate tags with commas.</div>
            </div>
            <style>
                #editor {
                    width: 100%;
                    min-height: 900px;
                    font-size: 18px !important;
                }

                #editor .toastui-editor-defaultUI {
                    border: 1px solid #ddd !important;
                    border-radius: 4px;
                    font-size: 18px !important;
                }

                #editor .toastui-editor-defaultUI .toastui-editor-md-container .CodeMirror {
                    font-size: 18px !important;
                    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
                }

                #editor .toastui-editor-defaultUI .toastui-editor-md-container .CodeMirror-code {
                    font-size: 18px !important;
                }

                #editor .toastui-editor-defaultUI .toastui-editor-md-container .CodeMirror-lines {
                    font-size: 18px !important;
                }

                #editor .toastui-editor-defaultUI .toastui-editor-md-container .toastui-editor-md-preview {
                    font-size: 18px !important;
                }

                #editor .toastui-editor-defaultUI .toastui-editor-md-container .toastui-editor-md-preview * {
                    font-size: 18px !important;
                }

                #editor .toastui-editor-defaultUI .toastui-editor-ww-container .toastui-editor-ww-mode {
                    font-size: 18px !important;
                }

                #editor .toastui-editor-defaultUI .toastui-editor-ww-container .toastui-editor-ww-mode * {
                    font-size: 18px !important;
                }

                #editor .toastui-editor-defaultUI .toastui-editor-md-tab-container .toastui-editor-md-tab-content {
                    font-size: 18px !important;
                }

                #editor .toastui-editor-defaultUI .toastui-editor-toolbar {
                    font-size: 16px !important;
                }

                #editor * {
                    font-size: inherit !important;
                }
            </style>
            <div id="editor" class="article-content">
            </div>
        </div>
        <textarea name="article-content" style='display:none'
            id="hiddenArea">{{ if .post }}{{ .post.Content }}{{ end }}</textarea>
        <br>
        <div class="d-flex flex-row-reverse">
            <button type="submit" class="btn btn-primary">{{ if .post }}Update{{ else }}Post{{ end }}</button>
        </div>
    </form>
</section>

<!-- Initialize TOAST UI Editor -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        try {
            const { Editor } = toastui;
            const { codeSyntaxHighlight } = Editor.plugin;
            const editor = new Editor({
                el: document.querySelector('#editor'),
                viewer: true,
                height: '900px',
                initialEditType: 'markdown',
                previewStyle: 'tab',
                plugins: [codeSyntaxHighlight],
            });
            // 에디터 초기화 후 폰트 사이즈 강제 적용
            setTimeout(() => {
                const editorElement = document.querySelector('#editor');
                if (editorElement) {
                    const style = document.createElement('style');
                    style.textContent = `
                        #editor .toastui-editor-defaultUI,
                        #editor .toastui-editor-defaultUI *,
                        #editor .CodeMirror,
                        #editor .CodeMirror *,
                        #editor .toastui-editor-md-preview,
                        #editor .toastui-editor-md-preview *,
                        #editor .toastui-editor-ww-mode,
                        #editor .toastui-editor-ww-mode * {
                            font-size: 18px !important;
                            font-family: inherit !important;
                        }
                    `;
                    document.head.appendChild(style);
                }
            }, 100);

            // Load existing content
            const hiddenArea = document.getElementById('hiddenArea');
            if (hiddenArea && hiddenArea.value) {
                editor.setMarkdown(hiddenArea.value);
            }

            // Handle form submission
            document.getElementById('blogform').addEventListener('submit', function () {
                hiddenArea.value = editor.getMarkdown();
            });

        } catch (error) {
            // Fallback to textarea
            const editorElement = document.getElementById('editor');
            if (editorElement) {
                editorElement.innerHTML = '<textarea id="fallback-editor" class="form-control" rows="20" placeholder="Markdown content"></textarea>';
                const fallback = document.getElementById('fallback-editor');
                const hiddenArea = document.getElementById('hiddenArea');
                if (hiddenArea && hiddenArea.value) {
                    fallback.value = hiddenArea.value;
                }
                document.getElementById('blogform').addEventListener('submit', function () {
                    hiddenArea.value = fallback.value;
                });
            }
        }
    });
</script>
{{ template "footer.html" . }}