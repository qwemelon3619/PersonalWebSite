{{ template "header.html" .}}
<!-- Toast UI Viewer + Syntax Highlighting + KaTeX -->
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.css" />
<link rel="stylesheet"
    href="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" />

<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<script
    src="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight-all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

<style>
    /* Light sky blue background for code blocks */
    pre {
        background-color: #e6f3ff !important;
    }

    /* Responsive images in article content */
    .article-content img {
        max-width: 100%;
        height: auto;
    }
</style>

<style>
    /* Match editor preview typography and spacing */
    .article-content {
        font-size: 18px;
        line-height: 1.7;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        color: #222;
    }

    .article-content * {
        font-size: inherit !important;
        font-family: inherit !important;
    }

    /* Code block styling consistent with editor preview */
    .article-content pre {
        background-color: #e6f3ff !important;
        padding: 1rem;
        border-radius: 6px;
        overflow: auto;
    }

    .article-content pre code,
    .article-content code {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Courier New', monospace;
        font-size: 0.95em;
    }

    /* Make tables responsive and readable */
    .article-content table {
        width: 100%;
        border-collapse: collapse;
    }

    .article-content th,
    .article-content td {
        border: 1px solid #e9ecef;
        padding: 0.5rem;
    }
</style>

<script>
    // Initialize syntax highlighting
    document.addEventListener('DOMContentLoaded', function () {
        // Highlight code blocks
        document.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
        });

        // Render math expressions with KaTeX
        document.querySelectorAll('.math').forEach((element) => {
            try {
                katex.render(element.textContent, element, {
                    throwOnError: false,
                    displayMode: element.classList.contains('math-display')
                });
            } catch (e) {
                console.warn('KaTeX rendering failed:', e);
            }
        });
    });
</script>
<!-- Page Content-->
<section class="py-5">
    <div class="container px-5 my-5">
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-9">
                <div class="article-wrapper">
                    <article>
                        <div class="mb-3">
                            <a href="javascript:history.back()" class="btn btn-outline-secondary btn-sm">‚Üê Back</a>
                        </div>
                        <header class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="text-muted small">By {{ .post.Author.Username }}</div>
                                {{ if and .isLoggedIn (eq .userId .post.Author.ID) }}
                                <div>
                                    <a class="btn btn-orange btn-sm me-2" href="/blog-edit/{{ .post.ID }}" role="button"
                                        value="Edit">Edit</a>
                                    <a class="btn btn-orange btn-sm" href="/blog-remove/{{ .post.ID }}" role="button"
                                        value="Remove">Remove</a>
                                </div>
                                {{ end }}
                            </div>
                            <h1 class="fw-bolder mb-1">
                                <span id="title-ko" style="display:none">{{.post.Title}}</span>
                                <span id="title-en">{{if
                                    .post.EnTitle}}{{.post.EnTitle}}{{else}}{{.post.Title}}{{end}}</span>
                            </h1>
                            <div class="text-muted fst-italic mb-2">{{ .post.UpdatedAt.Format "January 2, 2006" }}</div>
                            {{ if .post.Tags }}
                            <div class="mb-3">
                                {{ range $i, $t := .post.Tags }}
                                <a href="/blog?tag={{ $t.Name }}"
                                    class="badge bg-secondary text-decoration-none me-1">{{ $t.Name }}</a>
                                {{ end }}
                            </div>
                            {{ end }}
                            {{ if .post.Thumbnail }}
                            <img src="{{ .post.Thumbnail }}" alt="Thumbnail" class="img-fluid mb-3"
                                style="max-width: 100%; height: auto;">
                            {{ end }}

                        </header>
                        <!-- Language toggle -->
                        <div class="mb-3">
                            <div class="btn-group" role="group" aria-label="Language toggle">
                                <button id="lang-en" class="btn btn-outline-secondary btn-sm active">English</button>
                                <button id="lang-ko" class="btn btn-outline-secondary btn-sm">Korean</button>
                            </div>
                        </div>

                        <!-- Toast UI Viewer containers for both languages -->
                        <div id="viewer-en" class="article-content"></div>
                        <div id="viewer-ko" class="article-content" style="display: none;"></div>

                        <!-- Store raw markdown in hidden elements to avoid JS syntax issues in some environments -->
                        <div id="markdown-data" style="display:none" data-en="{{ .post.EnContent }}"
                            data-ko="{{ .post.Content }}"></div>

                        <div id="translation-notice" class="mt-3 text-muted small" style="display: none;">
                            Translated by DeepL
                        </div>
                    </article>
                </div>
            </div>
            <!-- Navigation Sidebar (Right) -->
            <nav class="col-lg-3 d-none d-lg-block ps-4">
                <div id="article-toc" class="position-sticky" style="top: 100px;"></div>
            </nav>
        </div>
    </div>
</section>
<script src="/templates/js/scripts.js"></script>
<script>
    // Language toggle functionality
    document.addEventListener('DOMContentLoaded', function () {
        const btnKo = document.getElementById('lang-ko');
        const btnEn = document.getElementById('lang-en');
        const titleKo = document.getElementById('title-ko');
        const titleEn = document.getElementById('title-en');
        const viewerKoEl = document.getElementById('viewer-ko');
        const viewerEnEl = document.getElementById('viewer-en');
        const translationNotice = document.getElementById('translation-notice');

        // Default to English
        if (translationNotice) translationNotice.style.display = 'block';

        btnKo.addEventListener('click', function () {
            btnKo.classList.add('active');
            btnEn.classList.remove('active');
            if (titleKo) titleKo.style.display = '';
            if (titleEn) titleEn.style.display = 'none';
            if (viewerKoEl) viewerKoEl.style.display = '';
            if (viewerEnEl) viewerEnEl.style.display = 'none';
            if (translationNotice) translationNotice.style.display = 'none';
            // Re-highlight code blocks after content change
            setTimeout(() => {
                document.querySelectorAll('#viewer-ko pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
                // Rebuild table of contents for Korean content
                if (typeof buildTOC === 'function') buildTOC();
            }, 10);
        });

        btnEn.addEventListener('click', function () {
            btnEn.classList.add('active');
            btnKo.classList.remove('active');
            if (titleKo) titleKo.style.display = 'none';
            if (titleEn) titleEn.style.display = '';
            if (viewerKoEl) viewerKoEl.style.display = 'none';
            if (viewerEnEl) viewerEnEl.style.display = '';
            if (translationNotice) translationNotice.style.display = 'block';
            // Re-highlight code blocks after content change
            setTimeout(() => {
                document.querySelectorAll('#viewer-en pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
                // Rebuild table of contents for English content
                if (typeof buildTOC === 'function') buildTOC();
            }, 10);
        });
    });
</script>
<script>
    // Build a floating table-of-contents from H2 headers inside the visible article content
    function slugify(text) {
        return text.toString().toLowerCase()
            .replace(/\s+/g, '-')           // Replace spaces with -
            .replace(/[^\u0000-\u7F\w\-]+/g, '') // Remove non-ascii/word chars
            .replace(/--+/g, '-')             // Replace multiple - with single -
            .replace(/^-+/, '')               // Trim - from start
            .replace(/-+$/, '');              // Trim - from end
    }

    function buildTOC() {
        const tocContainer = document.getElementById('article-toc');
        if (!tocContainer) return;
        tocContainer.innerHTML = '';
        // determine visible content container
        const viewerEn = document.getElementById('viewer-en');
        const viewerKo = document.getElementById('viewer-ko');
        let content = viewerEn;
        if (viewerKo && getComputedStyle(viewerKo).display !== 'none') content = viewerKo;
        if (!content) return;

        const headers = content.querySelectorAll('h2');
        if (!headers || headers.length === 0) return;

        const box = document.createElement('div');
        box.className = 'toc-box p-3 bg-light border rounded';
        const title = document.createElement('div');
        title.className = 'fw-bold mb-2';
        title.textContent = 'On This Page';
        box.appendChild(title);

        const ul = document.createElement('ul');
        ul.className = 'list-unstyled small mb-0';

        headers.forEach((h, idx) => {
            if (!h.id || h.id.trim() === '') {
                // simple slugify replacement
                const slug = h.textContent.trim().toLowerCase().replace(/[^a-z0-9]+/g, '-');
                h.id = 'section-' + (slug || idx);
            }
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#' + h.id;
            a.className = 'toc-link d-block text-decoration-none py-1';
            a.textContent = h.textContent;
            a.addEventListener('click', function (e) {
                e.preventDefault();
                document.getElementById(h.id).scrollIntoView({ behavior: 'smooth', block: 'start' });
                // update active class
                document.querySelectorAll('.toc-link').forEach(x => x.classList.remove('active'));
                a.classList.add('active');
            });
            li.appendChild(a);
            ul.appendChild(li);
        });

        box.appendChild(ul);
        tocContainer.appendChild(box);

        // highlight current section on scroll
        const headingNodes = Array.from(headers);
        function onScroll() {
            const fromTop = window.scrollY + 110; // offset to account for sticky header
            let current = headingNodes[0];
            for (const h of headingNodes) {
                if (h.offsetTop <= fromTop) current = h;
                else break;
            }
            if (current) {
                document.querySelectorAll('.toc-link').forEach(x => x.classList.remove('active'));
                const activeLink = tocContainer.querySelector('a[href="#' + current.id + '"]');
                if (activeLink) activeLink.classList.add('active');
            }
        }
        window.removeEventListener('scroll', window._tocScrollHandler || function () { });
        window._tocScrollHandler = onScroll;
        window.addEventListener('scroll', window._tocScrollHandler);
        // initial highlight
        onScroll();
    }

    // TOC styling
    const style = document.createElement('style');
    style.textContent = `
    #article-toc .toc-box{ max-height: 60vh; overflow:auto; }
    #article-toc .toc-link{ color: #333; }
    #article-toc .toc-link.active{ font-weight: 600; color: #0d6efd; }
`;
    document.head.appendChild(style);
</script>
<script>
    // Initialize Toast UI Viewer instances using embedded markdown
    document.addEventListener('DOMContentLoaded', function () {
        try {
            const dataEl = document.getElementById('markdown-data');
            const mdEn = dataEl ? dataEl.dataset.en : '';
            const mdKo = dataEl ? dataEl.dataset.ko : '';

            const { Editor } = toastui;
            const { codeSyntaxHighlight } = Editor.plugin;
            const enEl = document.querySelector('#viewer-en');
            const koEl = document.querySelector('#viewer-ko');
            if (enEl) {
                window.__viewerEn = toastui.Editor.factory({
                    el: enEl,
                    viewer: true,
                    initialValue: mdEn,
                    plugins: [codeSyntaxHighlight],
                    height: 'auto'
                });
            }
            if (koEl) {
                window.__viewerKo = toastui.Editor.factory({
                    el: koEl,
                    viewer: true,
                    initialValue: mdKo,
                    plugins: [codeSyntaxHighlight],
                    height: 'auto'
                });
            }
            // ensure TOC builds against viewer-rendered HTML
            setTimeout(buildTOC, 100);
        } catch (e) {
            console.warn('Toast UI Viewer init failed:', e);
        }
    });
</script>
</main>

{{ template "footer.html" .}}