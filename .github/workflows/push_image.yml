name: Build and Deploy to Azure App Service

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        with:
          driver: docker-container
      - name: Create and use buildx builder
        run: |
          # create a container-backed builder and use it (idempotent)
          docker buildx create --name mybuilder --driver docker-container --use || true
          docker buildx inspect --bootstrap
      - name: Cache Go modules and build cache
        uses: actions/cache@v4
        with:
          path: |
            /home/runner/go/pkg/mod
            /home/runner/.cache/go-build
          key: ${{ runner.os }}-go-cache-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-cache-

      - name: Pre-download Go modules for all services
        run: |
          set -e
          for d in services/auth-service services/post-service services/img-service services/api-gateway services/web-front; do
            if [ -f "$d/go.mod" ]; then
              echo "Downloading modules for $d"
              (cd "$d" && go mod download)
            fi
          done

      # 1. Azure Login
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 2. Azure Container Registry Login
      - name: Docker Login to ACR
        uses: azure/docker-login@v2
        with:
          login-server: ${{ secrets.REGISTRY_LOGIN_SERVER }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      # 3. Build and Push Images to ACR (all services)
      - name: Build and push images (with buildx cache)
        env:
          IMAGE_TAG: ${{ github.sha }}
          IMAGE_PREFIX: ${{ secrets.REGISTRY_LOGIN_SERVER }}
        run: |
          # Use buildx and registry cache to speed up dependency download between CI runs
          # Cache will be stored in the registry (requires write access)
          docker buildx build \
            --platform linux/amd64 \
            -t ${IMAGE_PREFIX}/api-gateway:${IMAGE_TAG} -f services/api-gateway/Dockerfile . --push

          docker buildx build \
            --platform linux/amd64 \
            -t ${IMAGE_PREFIX}/auth-service:${IMAGE_TAG} -f services/auth-service/Dockerfile . --push

          docker buildx build \
            --platform linux/amd64 \
            -t ${IMAGE_PREFIX}/post-service:${IMAGE_TAG} -f services/post-service/Dockerfile . --push

          docker buildx build \
            --platform linux/amd64 \
            -t ${IMAGE_PREFIX}/img-service:${IMAGE_TAG} -f services/img-service/Dockerfile . --push

          docker buildx build \
            --platform linux/amd64 \
            -t ${IMAGE_PREFIX}/web-front:${IMAGE_TAG} -f services/web-front/Dockerfile . --push

      # 4. Deploy to Azure App Service
      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          images: '${{ secrets.REGISTRY_LOGIN_SERVER }}/web-front:${{ github.sha }}'

      # 5. Azure Logout
      - name: Azure Logout
        run: |
          az logout || true
